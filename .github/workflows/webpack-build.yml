name: Node.js Webpack Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-webpack:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['18', '20', '22']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        npm install webpack webpack-cli webpack-dev-server

    - name: Create webpack configuration
      run: |
        cd frontend
        cat > webpack.config.js << 'EOF'
        const path = require('path');
        const HtmlWebpackPlugin = require('html-webpack-plugin');
        const { CleanWebpackPlugin } = require('clean-webpack-plugin');
        const MiniCssExtractPlugin = require('mini-css-extract-plugin');
        
        module.exports = {
          mode: process.env.NODE_ENV || 'development',
          entry: {
            main: './src/app/page.tsx',
          },
          output: {
            path: path.resolve(__dirname, 'dist'),
            filename: '[name].[contenthash].js',
            clean: true,
          },
          module: {
            rules: [
              {
                test: /\.tsx?$/,
                use: 'ts-loader',
                exclude: /node_modules/,
              },
              {
                test: /\.css$/,
                use: [MiniCssExtractPlugin.loader, 'css-loader'],
              },
              {
                test: /\.(png|svg|jpg|jpeg|gif)$/i,
                type: 'asset/resource',
              },
            ],
          },
          resolve: {
            extensions: ['.tsx', '.ts', '.js'],
          },
          plugins: [
            new CleanWebpackPlugin(),
            new HtmlWebpackPlugin({
              template: './src/app/layout.tsx',
            }),
            new MiniCssExtractPlugin({
              filename: '[name].[contenthash].css',
            }),
          ],
          optimization: {
            splitChunks: {
              chunks: 'all',
            },
          },
        };
        EOF

    - name: Run Webpack Build
      run: |
        cd frontend
        npm run webpack:build
        
    - name: Build Analysis
      run: |
        cd frontend
        npm install --save-dev webpack-bundle-analyzer
        npx webpack-bundle-analyzer dist/static/js/*.js

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files-node-${{ matrix.node-version }}
        path: frontend/dist/
        retention-days: 30

  webpack-optimization:
    runs-on: ubuntu-latest
    needs: build-and-webpack

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Performance Budget Check
      run: |
        cd frontend
        npm install --save-dev webpack-bundle-analyzer
        npx webpack --mode=production --profile > webpack-stats.json
        
        # Check bundle size (example threshold)
        BUNDLE_SIZE=$(du -sh dist/static/js/*.js | awk '{print $1}' | head -1)
        echo "Bundle size: $BUNDLE_SIZE"
        
        # You can add logic to fail if bundle is too large
        if [ $(echo "$BUNDLE_SIZE" | tr -d '0-9.') -gt 500 ]; then
          echo "Bundle size exceeds threshold"
          exit 1
        fi

    - name: Tree Shaking Verification
      run: |
        cd frontend
        # Verify that unused code is removed
        npx webpack --mode=production --analyze | grep -E "Size|Gzipped" || true

  deployment-ready:
    runs-on: ubuntu-latest
    needs: [build-and-webpack, webpack-optimization]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files-node-20
        path: frontend/dist/

    - name: Create deployment package
      run: |
        cd frontend/dist
        tar -czf ../adx-agent-frontend.tar.gz .
        
    - name: Upload deployment package
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: frontend/adx-agent-frontend.tar.gz

  lighthouse-performance:
    runs-on: ubuntu-latest
    needs: build-and-webpack

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        npm run build
        
    - name: Start local server
      run: |
        cd frontend
        npm run start &
        sleep 10
        
    - name: Run Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: './frontend/lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true
        
    - name: Performance Budget Check
      run: |
        # Example performance budget checks
        # Add thresholds based on your requirements
        echo "Performance budget checks would go here"
        
  bundle-analysis:
    runs-on: ubuntu-latest
    needs: build-and-webpack

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        npm install webpack-bundle-analyzer

    - name: Generate Bundle Analysis
      run: |
        cd frontend
        npm run build
        npx webpack-bundle-analyzer dist/static/js/*.js dist/static/css/*.css
        
    - name: Upload Bundle Analysis
      uses: actions/upload-artifact@v4
      with:
        name: bundle-analysis
        path: frontend/dist-report.html

  security-audit:
    runs-on: ubuntu-latest
    needs: build-and-webpack

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Run npm audit
      run: |
        cd frontend
        npm audit --audit-level=moderate
        
    - name: Check for known vulnerabilities
      run: |
        cd frontend
        npm audit --json > audit-report.json
        
    - name: Upload audit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-audit-report
        path: frontend/audit-report.json